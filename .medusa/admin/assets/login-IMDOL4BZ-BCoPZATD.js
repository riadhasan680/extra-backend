import{A as I}from"./chunk-O333RR6K-Bgu5YGf9.js";import{b as p,c as T,u as j,a as _,aC as H,aD as U,gv as $,fd as z,j as e,H as B,a3 as R,J as m,K as A,a1 as D,B as S,L as O,au as W,gw as K,r as f,bj as V,ax as q,az as P,s as b,t as F,gx as J}from"./index-D2YvuHvs.js";import{l as G}from"./index.modern-CfLsNAiL.js";import{T as M}from"./Trans-CpX4fwIJ.js";import{A as Q}from"./alert-BU7ep9fJ.js";import"./chunk-KIIT4BNH-DzPEFzBZ.js";var h="cloud",X=()=>{const{t}=p(),[a]=W(),{data:r}=K(),n=a.get("auth_provider")===h&&a.get("auto")==="true",o=a.get("auth_provider")===h&&(a.has("code")||a.has("error")),{handleLogin:s,isLoginPending:l}=Y(n),{handleCallback:c,isCallbackPending:d}=Z(a),i=f.useRef(!1);return f.useEffect(()=>{i.current||(n?(i.current=!0,s()):o&&(i.current=!0,c()))},[n,o,s,c]),n||o?e.jsx("div",{className:"bg-ui-bg-subtle fixed inset-0 z-50 flex items-center justify-center",children:e.jsx(V,{className:"text-ui-fg-subtle animate-spin"})}):r!=null&&r.enabled?e.jsxs(e.Fragment,{children:[e.jsx("hr",{className:"bg-ui-border-base my-4"}),e.jsx(S,{variant:"secondary",onClick:s,className:"w-full",disabled:l||d,isLoading:l||d,children:t("auth.login.cloud")})]}):null},Y=t=>{const{t:a}=p(),r=j(),[n,o]=f.useState(!1);return{handleLogin:f.useCallback(async()=>{o(!0);try{const l=await b.auth.login("user",h,{callback_url:`${window.location.origin}${window.location.pathname}?auth_provider=${h}`});if(typeof l=="object"&&l.location){window.location.href=l.location;return}throw new Error("Unexpected login response")}catch{F.error(a("auth.login.authenticationFailed")),t&&r("/login")}o(!1)},[a,r,t]),isLoginPending:n}},Z=t=>{const{t:a}=p(),r=j(),{mutateAsync:n}=J(),[o,s]=f.useState(!1);return{handleCallback:f.useCallback(async()=>{s(!0);try{let c;try{const i=Object.fromEntries(t);delete i.auth_provider,c=await b.auth.callback("user",h,i)}catch{throw new Error("Authentication callback failed")}const d=G(c);if(!(d!=null&&d.actor_id)&&(await n(),!await b.auth.refresh({Authorization:`Bearer ${c}`})))throw new Error("Failed to refresh token after user creation");r("/")}catch{F.error(a("auth.login.authenticationFailed")),r("/login")}s(!1)},[t,a,n,r]),isCallbackPending:o}},ee=q({email:P().email(),password:P()}),oe=()=>{var w,y,C,E,N,k,L;const{t}=p(),a=T(),r=j(),{getWidgets:n}=_(),o=((y=(w=a.state)==null?void 0:w.from)==null?void 0:y.pathname)||"/orders",s=H({resolver:U(ee),defaultValues:{email:"",password:""}}),{mutateAsync:l,isPending:c}=$(),d=s.handleSubmit(async({email:u,password:g})=>{await l({email:u,password:g},{onError:x=>{if(z(x)&&x.status===401){s.setError("email",{type:"manual",message:x.message});return}s.setError("root.serverError",{type:"manual",message:x.message})},onSuccess:()=>{r(o,{replace:!0})}})}),i=(N=(E=(C=s.formState.errors)==null?void 0:C.root)==null?void 0:E.serverError)==null?void 0:N.message,v=((k=s.formState.errors.email)==null?void 0:k.message)||((L=s.formState.errors.password)==null?void 0:L.message);return e.jsx("div",{className:"bg-ui-bg-subtle flex min-h-dvh w-dvw items-center justify-center",children:e.jsxs("div",{className:"m-4 flex w-full max-w-[280px] flex-col items-center",children:[e.jsx(I,{}),e.jsxs("div",{className:"mb-4 flex flex-col items-center",children:[e.jsx(B,{children:t("login.title")}),e.jsx(R,{size:"small",className:"text-ui-fg-subtle text-center",children:t("login.hint")})]}),e.jsxs("div",{className:"flex w-full flex-col gap-y-3",children:[n("login.before").map((u,g)=>e.jsx(u,{},g)),e.jsx(m,{...s,children:e.jsxs("form",{onSubmit:d,className:"flex w-full flex-col gap-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-y-1",children:[e.jsx(m.Field,{control:s.control,name:"email",render:({field:u})=>e.jsx(m.Item,{children:e.jsx(m.Control,{children:e.jsx(A,{autoComplete:"email",...u,className:"bg-ui-bg-field-component",placeholder:t("fields.email")})})})}),e.jsx(m.Field,{control:s.control,name:"password",render:({field:u})=>e.jsxs(m.Item,{children:[e.jsx(m.Label,{}),e.jsx(m.Control,{children:e.jsx(A,{type:"password",autoComplete:"current-password",...u,className:"bg-ui-bg-field-component",placeholder:t("fields.password")})})]})})]}),v&&e.jsx("div",{className:"text-center",children:e.jsx(D,{className:"inline-flex",variant:"error",children:v})}),i&&e.jsx(Q,{className:"bg-ui-bg-base items-center p-2",dismissible:!0,variant:"error",children:i}),e.jsx(S,{className:"w-full",type:"submit",isLoading:c,children:t("actions.continueWithEmail")})]})}),[...n("login.after"),X].map((u,g)=>e.jsx(u,{},g))]}),e.jsx("span",{className:"text-ui-fg-muted txt-small my-6",children:e.jsx(M,{i18nKey:"login.forgotPassword",components:[e.jsx(O,{to:"/reset-password",className:"text-ui-fg-interactive transition-fg hover:text-ui-fg-interactive-hover focus-visible:text-ui-fg-interactive-hover font-medium outline-none"},"reset-password-link")]})})]})})};export{oe as Component};
